<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="./common/images/favicon.svg" sizes="any">
<title>計算ツール</title>
<link rel="stylesheet" href="./common/css/reset.css">
<link rel="stylesheet" href="./common/css/style.css?aa">
<link rel="stylesheet" href="./common/css/modal.css?aa">
<link rel="stylesheet" href="./common/css/tools.css?aa">
<style>
  body {
	user-select: none;
}
.flex{
  display:flex;
}
.range {
  background-color: #6eb6e4;
  min-height: initial;
  height: 0px;
  border: 0;
  border-radius: 6px;
  outline: none;
}
.range::-webkit-slider-thumb{
    -webkit-appearance:none;
    background:#fff;
    height:15px;
    width:15px;
    border:2px solid #6eb6e4;
    border-radius:50%;
}
.outer > div, .outer > img{
  text-align:center;
  display: table-cell;
  vertical-align:middle;
}
/* トビネズミ */
#animal{
  margin: 50px auto;
  width: 50px;
}
#question{
  height: 120px;
  background:#ecf4f9;
  border-radius: 5px;
  text-align:center;
  display: table-cell;
  font-size: 4rem;
  letter-spacing: 1rem;
}
/* PC */
@media screen and (min-width: 960px) {
  #question {
    height: 120px;
  }
}
/* 小さい画面 */
@media screen and (max-width: 375px) {
  #question {
    height: 70px;
    font-size: 3rem;
    margin:30px auto;
    /* background-color: red; */
  }
  #tab_level{
    margin: 0 auto ;
    /* background-color: blue; */
    margin-bottom: 10px;
  }
  #tab_level div{
    height: 30px;
    font-size: 1.2rem;
  }
}
.ruby3{
  font-size:18px;
  height:30px;
  padding-top:0;;
  padding-bottom:20px;
  color: #fdfdfd;
} 
#answer{
  font-size: 3rem;
}
#js_ok{
  width: 50px;
  height: 110px;
  line-height: 110px;
  color:#fff;
  background-color: rgb(193, 76, 76);
  text-align: center;
  cursor: pointer;
}
.box{
  font-size: 1rem;
  cursor: pointer;
  border:1px solid #000;
  width:20px;
  height:20px;
  line-height:20px;
  margin: 0;
  text-align: center;
}
.box.-l{
  font-size: 3rem;
  cursor: pointer;
  border:1px solid #000;
  width:40px;
  height:40px;
  line-height:40px;
  margin: 0;
  text-align: center;
}
.tenkey_box li{
  height: 50px;
  font-size: 1.8rem; 
}
/*==================================================
ふわっ
===================================*/
/* p{
  margin:50px 0;
} */

.flex{
  display:flex;
  flex-wrap: wrap;
}

.fadeUp{
  animation-name:fadeUpAnime;
  animation-duration:0.3s;
  animation-fill-mode:forwards;
  opacity:0;
}

@keyframes fadeUpAnime{
  from {
    opacity: 0;
    transform: translateY(1000px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
#ok_sign{
  position:absolute;
  width: 100%;
  height: 100%;
  margin: 0 auto;
  font-size: 6rem;
  color:rgb(227, 49, 49);
  background:#fff;
  border-radius: 10px;
  display: none;
  z-index:9999;
}
.status{
  min-width: 45px;
  font-size: 2rem;
}
.btn.-s{
  padding:2px;
}

.help_box{
    display: flex;
    /* padding: 2px; */
}
.help_box>div{
    margin: 0;
    text-align: center;
    min-width:30px;
    height:50px;
    line-height: 50px;
}
.help_box>div:nth-of-type(1){
    margin-right: auto;
}
#timer{
  font-size:1rem;
}
#howto{
  position:absolute;
  width:98%;
  margin: 0 auto;
  height: 100%;
  background-color: #fff;
  opacity: 0.9;
  color: #514c4c;
  text-align:center;
  line-height: 3rem;
  z-index: 999;
  font-size:1rem;
  padding-top: 60px;
}
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DP1WEV1PRZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DP1WEV1PRZ');
</script>
<body>
<div class="container">
  <header></header>
  <main>
    <!-- HOWTO -->
    <div id="howto">
      <p> 素因数分解する単純なゲームです。</p> 
      <p>レベルが１〜５まであるから好きなの選んでね</p> 
      <p>クマが邪魔してくるから早めに解答して！！</p> 
      <hr>
      <div><img src="./common/images/icon/beginner.png" class="icon"> ヒントの表示・非表示</div>
      <div><img src="./common/images/icon/kuma.png " class="icon -s"> クマさんの表示・非表示</div>
      <div><img src="./common/images/icon/close.png" class="icon -ss"> 終了</div>
    </div>
    <!-- ヘルプ -->
    <div class="help_box">
      <div id="timer" class="timer">0.00</div>
      <div id="help"></div>
      <div><img src="./common/images/icon/beginner.png" class="icon" id="display_help"></div>
      <div><img src="./common/images/icon/kuma.png " class="icon -s" id="display_animal"></div>
      <div><img src="./common/images/icon/close.png" class="icon -ss" onclick="init()"></div>
    </div>
    <!-- レベル -->
    <div class="btnBox" id="tab_level">
      <div style="display: inline-block">level</div>
      <div class="status" data-level="1">1</div>
      <div class="status" data-level="2">2</div>
      <div class="status -green" data-level="3">3</div>
      <div class="status" data-level="4">4</div>
      <div class="status" data-level="5">5</div>
    </div>
    <!-- 設問 -->
    <div class="outer"><div id="ok_sign">OK</div></div>
    <div class="outer"><div id="question"></div></div>
    <div class="outer"><div id="answer"></div></div>
    <div class="outer"><div id="prime" class="ruby3"></div></div>
    <div class="outer">
      <img src="./common/images/icon/kuma.png" id="animal" class="animal">
    </div>
  </main>

  <!-- footer -->
  <footer>
    <!-- kenkey -->
    <table width="100%">
      <tr>
        <td rowspan="3">
          <ul class="tenkey_box -column3">
            <li>2</li>
            <li>3</li>
            <li>5</li>
            <li>7</li>
            <li>11</li>
            <li>13</li>
            <li>17</li>
            <li>19</li>
            <li>23</li>
          </ul>
        </td>
        <td style="text-align:center;width: 60px !important; height:50px;">
          <div id="js_clear" class="box -l">×</div>
        </td>
      </tr>
      <tr>
        <td rowspan="2" style="text-align:center;">
          <div id="js_ok">GO</div>
        </td>
      </tr>
    </table>
  </footer>
</div><!-- container -->
<script src="./common/js/jquery-3.6.3.min.js"></script>
<script src="./common/js/jquery-ui.js"></script>
<script src="./common/js/common.js?test"></script>
<script src="./common/js/tools.js?test"></script>
<!-- <script src="./common/js/calc.js?test"></script> -->
<script>
/*----------------------------
Roku tools
*/
'use strict';
//https://k3su.xyz/
const prime_choices = [2, 3, 5, 7, 11, 13, 17, 19, 23];
let question = '';
let primes = [];
let answer = [];
let level=3;
let min, max;
let levels = {1:{'min':50,'max':100}, 
          2:{'min':101,'max':500},
          3:{'min':501,'max':1000},
          4:{'min':1001,'max':2000},
          5:{'min':2001,'max':3000}};
let is_running = false;
let interval_id;
let animal = $('#animal');
let animal_offset = animal.offset();

//-------------------------
// タブ
$('#tab_level div').click(function(){
  $('.status').removeClass('-green');
  $(this).addClass('-green');
  level = $(this).data('level');
  // 問を作成する
  start();
})

//-------------------------
// スタート
$('#question,#answer,#animal,#howto,.tenkey').click(function(){
  start();
})
$(document).keydown(function(event) {
	if(event.keyCode==32){
    start();
  }
});

//-------------------------
// init
function init(){
  is_running = false;
  clearInterval(interval_id);
  $('#howto').remove();
  animal.removeClass('animal_purun');
  animal.css('width', '50px');
  // トビネズミを元の位置に
  animal.css({ "width": "", "height": "" });
  animal.offset(animal_offset);
  min = levels[level]['min'];
  max = levels[level]['max'];
  question='';
  answer = [];
  $('#question').html('');
  $('#answer').html('');
  $('#ok_sign').removeClass('fadeUp');
  $('#ok_sign').css('display', 'none');
  $('#help').html('');
  clearTimeout(timerid);
  $($('#timer').html('0.00'));
}
let animal2 = animal;
//-------------------------
// スタート
function start(){
  init();
  setTimer();
  runTimer();
  generateNumber();
  animal.addClass('animal_purun');
    // クマさんを少しずつ大きくする
    if(!is_running){
      is_running = true;
      interval_id = setInterval(function(){
        let w = animal.width();
        if(w<400){
          animal.css('width', (w+4)+'px')
          let off = animal.offset();
          animal.offset({top: off.top-4, left:off.left-1})
        }
      }, 500);
    }


    // animal.css('display', 'none');
}

//-------------------------
// 問を作成する
function generateNumber(){
  for(let i=0; i<30; i++){
    // 乱数取得
    question = getRand(min, max);
    $('#question').html(question);
    // 素因数分解する
    primes = prime(question);
    let flg = true;
    $('#prime').html(primes.join(','));

    if(primes.length == 1){
      //-------------------------
      // rand自体が素数なのでやり直し
      flg = false;
    } else {
      //-------------------------
      // 選択肢に含まれない素数がないかチェック
      primes.forEach(function(pri){
        if(!in_array(pri, prime_choices)){
        // if(prime_choices.indexOf(pri) === -1){
          flg = false
        }
      })
    }
    if(flg){
      // 条件に収まる数値がきたら終了！
      break;
    }
  }
}

//-------------------
// テンキー
//-------------------
$('.tenkey_box li').click(function(){
  console.log(question);
    if(question==''){
      return;
    }
    let n = $(this).html();
    answer.push(parseInt(n));
    $('#answer').html(answer.join(', '));
    setHelp();
    setTimer();
    // ヘルプ表示時、間違った数字をタップしたらガクブル
    if(!in_array(parseInt(n), primes)){
      Gakuburu($('#question'), 100);
    }
})
//-------------------
// help
//-------------------
function setHelp(){
  let help=question;
  for(let i=0; i<answer.length; i++){
    help = help/answer[i];
  }
  $('#help').removeClass('txtRed');
  if(help==1){
    help = '';
  } else if(!Number.isInteger(help)){
    $('#help').addClass('txtRed');
    help =help.toFixed(2);
  }
  $('#help').html(help);
}
/*-----------------------
 判定！！OK
-----------------------*/
$('#js_ok').click(function(){
  if(answer.length>0 && JSON.stringify(primes.sort()) === JSON.stringify(answer.sort())){
    // 正解！！
    // 1秒後に次の問題へ
    $('#ok_sign').addClass('fadeUp');
    $('#ok_sign').css('display', 'block');
    setTimeout(() => {
      start();
    }, "1000");
  } else {
    // 不正解!!
    Gakuburu($('#question'));
  }
})
/*-----------------------
 clear
-----------------------*/
$('#js_clear').click(function(){
    answer.pop();
    setHelp();
    $('#answer').html(answer.join(', '));
})
/*-----------------------
  素因数分解
-----------------------*/
function prime(val){
    let primes = [];
    if(Number(val)){
        for(let i=2; i<=50; i++){
            for(let j=0; j<10; j++){
                if(val % i ==0){
                  primes.push(i);
                    val = val/i;
                } else {
                    break;
                }
            }
        }
        if(val>1){
          primes.push(parseInt(val));
        }
    }
    return primes;
}


// クマさんtoggle
$('#display_animal').click(function(){
  if($('#animal').css('display')=='none'){
    $(this).attr('src', './common/images/icon/kuma.png');
  } else {
    $(this).attr('src', './common/images/icon/kuma_gray.png');
  }
  animal.toggle();
})
// ヘルプtoggle
$('#display_help').click(function(){
  if($('#help').css('display')=='none'){
    $(this).attr('src', './common/images/icon/beginner.png');
  } else {
    $(this).attr('src', './common/images/icon/beginner_gray.png');
  }
  $('#help').toggle();
})
// オブジェクトを中央に
jQuery.prototype.offsetCenter=function() {
  var left=this.offset().left;
  var top=this.offset().top;
  var width=this.width();
  var height=this.height();
  left=left+(width/2);
  top=top+(height/2);
  return {
    top,
    left
  }
}

</script>
</body>
</html> 
